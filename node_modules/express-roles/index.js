var _ = require('lodash');

module.exports = function(roles) {
  var expectedRoles = _.isArray(roles) ? roles : arguments;
  return function(request, result, nextHandler) {
    if(_.isUndefined(request.user) || _.isUndefined(request.user.roles)) return result.sendStatus(401);
    if(_.some(expectedRoles)) {
      var userHasRoles = _.every(expectedRoles, function(role) {
        return _.includes(request.user.roles, role);
      });
      if(userHasRoles) return nextHandler();
      return result.sendStatus(401);
    }
    return nextHandler();
  };
};